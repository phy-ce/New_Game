import sys
import os

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€ (backend í´ë”ë¥¼ ì°¾ê¸° ìœ„í•¨)
sys.path.append(os.getcwd())

from backend.app.core.engine import GameState, Engine, Phase
from backend.app.core.card import CARD_DB

def test_engine_all_logic():
    print("ğŸš€ [ì—”ì§„ í†µí•© ê²€ì¦ í…ŒìŠ¤íŠ¸] ì‹œì‘\n")
    
    # 1. ì´ˆê¸°í™” (User_A, User_B)
    player_ids = ["User_A", "User_B"]
    state = GameState(player_ids, debug=True)
    engine = Engine(state)
    engine.setup_game()
    
    player_a = state.players["User_A"]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì‹œë‚˜ë¦¬ì˜¤ 1: play_card ë³µí•© ì—ëŸ¬ í…ŒìŠ¤íŠ¸
    # ìƒí™©: User_Aì˜ í„´ì¸ë° User_Bê°€, Phaseê°€ ACTIONì´ ì•„ë‹ ë•Œ, ì•¡ì…˜ ì¹´ë“œë¥¼ í”Œë ˆì´ ì‹œë„
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("--- [ì‹œë‚˜ë¦¬ì˜¤ 1] play_card: íƒ€ì¸ í„´ + í˜ì´ì¦ˆ ë¶ˆì¼ì¹˜ ì—ëŸ¬ ìˆ˜ì§‘ ---")
    state.turn_owner = "User_A"
    state.phase = Phase.BUY # í˜„ì¬ êµ¬ë§¤ í˜ì´ì¦ˆ
    
    # User_Bê°€ ìê¸° í•¸ë“œì— ìˆì§€ë„ ì•Šì€ ì¹´ë“œë¥¼ í”Œë ˆì´ ì‹œë„
    success1, msg1 = engine.play_card("User_B", "Village")
    
    print(f"ê²°ê³¼: {success1}")
    print(f"ì—ëŸ¬ ë©”ì‹œì§€: {msg1}")
    
    if "ë³¸ì¸ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤" in msg1 and "ì†íŒ¨ì— Village ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤" in msg1:
        print("âœ… ì—¬ëŸ¬ ê°œì˜ ì—ëŸ¬ê°€ ' | 'ë¡œ ì˜ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print("âŒ ì—ëŸ¬ í†µí•© ë¡œì§ í™•ì¸ í•„ìš”")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì‹œë‚˜ë¦¬ì˜¤ 2: buy_card ë³µí•© ì—ëŸ¬ í…ŒìŠ¤íŠ¸
    # ìƒí™©: êµ¬ë§¤ê¶Œë„ ì—†ê³ , ëˆë„ ì—†ëŠ”ë°, ë¹„ì‹¼ ì¹´ë“œë¥¼ ì‚¬ë ¤ê³  í•  ë•Œ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n--- [ì‹œë‚˜ë¦¬ì˜¤ 2] buy_card: êµ¬ë§¤ê¶Œ ë¶€ì¡± + ê³¨ë“œ ë¶€ì¡± ì—ëŸ¬ ìˆ˜ì§‘ ---")
    state.phase = Phase.BUY
    player_a["buys"] = 0
    player_a["gold"] = 0
    
    success2, msg2 = engine.buy_card("User_A", "Province")
    
    print(f"ê²°ê³¼: {success2}")
    print(f"ì—ëŸ¬ ë©”ì‹œì§€: {msg2}")
    
    if "ë‚¨ì€ êµ¬ë§¤ íšŸìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤" in msg2 and "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" in msg2:
        print("âœ… êµ¬ë§¤ ì—ëŸ¬ í†µí•© ì„±ê³µ!")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì‹œë‚˜ë¦¬ì˜¤ 3: ì •ìƒ íë¦„ ë° ìŠ¹ì  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n--- [ì‹œë‚˜ë¦¬ì˜¤ 3] ì •ìƒ íë¦„: Province êµ¬ë§¤ ë° VP í™•ì¸ ---")
    player_a["buys"] = 1
    player_a["gold"] = 8
    
    success3, msg3 = engine.buy_card("User_A", "Province")
    print(f"êµ¬ë§¤ ê²°ê³¼: {success3} | ë©”ì‹œì§€: {msg3}")
    print(f"User_A ìµœì¢… VP: {player_a['victory_points']} (ì˜ˆìƒ: 9)")
    
    if player_a["victory_points"] == 9:
        print("âœ… ìŠ¹ì  ì—…ë°ì´íŠ¸ ë¡œì§ ì •ìƒ ì‘ë™ (ì¤‘ê°„ì— return ë˜ì§€ ì•ŠìŒ)")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ“œ ì „ì²´ ê²Œì„ ë¡œê·¸ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n" + "="*60)
    print("ğŸ“œ [ìµœì¢… ë¡œê·¸ ë°ì´í„° í™•ì¸]")
    print("="*60)
    for i, log in enumerate(state.logs, 1):
        print(f"{i:02d} | {log}")
    print("="*60)

if __name__ == "__main__":
    test_engine_all_logic()