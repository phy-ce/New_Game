import sys
import os

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì¶”ê°€ (backend ë””ë ‰í† ë¦¬ê°€ ë³´ì´ë„ë¡)
sys.path.append(os.getcwd())

from backend.app.core.engine import GameState, Engine, Phase
from backend.app.core.card import CARD_DB

def test_buy_limit_logic():
    print("ğŸš€ [êµ¬ë§¤ íšŸìˆ˜(buys) ì œí•œ ë¡œì§ í…ŒìŠ¤íŠ¸] ì‹œì‘\n")
    
    # 1. ì´ˆê¸°í™”
    player_ids = ["User_A", "User_B"]
    state = GameState(player_ids)
    engine = Engine(state)
    engine.setup_game()
    
    player_a = state.players["User_A"]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ êµ¬ë§¤ ì œí•œ í…ŒìŠ¤íŠ¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("--- [ì‹œë‚˜ë¦¬ì˜¤ 1] ê¸°ë³¸ êµ¬ë§¤ ì œí•œ í…ŒìŠ¤íŠ¸ ---")
    player_a["gold"] = 10
    player_a["buys"] = 1
    state.phase = Phase.BUY  # êµ¬ë§¤ í˜ì´ì¦ˆ ê°•ì œ ì„¤ì •
    
    # ì²« ë²ˆì§¸ êµ¬ë§¤
    success1, _ = engine.buy_card("User_A", "Copper")
    # ë‘ ë²ˆì§¸ êµ¬ë§¤ ì‹œë„ (ì°¨ë‹¨ë˜ì–´ì•¼ í•¨)
    success2, msg2 = engine.buy_card("User_A", "Silver")
    
    print(f"ì²« ë²ˆì§¸ êµ¬ë§¤: {success1}, ë‘ ë²ˆì§¸ êµ¬ë§¤: {success2} (ì°¨ë‹¨ ë©”ì‹œì§€: {msg2})")
    print("-" * 40)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ì‹œë‚˜ë¦¬ì˜¤ 2: Market ì‚¬ìš© í›„ ì—°ì† êµ¬ë§¤ í…ŒìŠ¤íŠ¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n--- [ì‹œë‚˜ë¦¬ì˜¤ 2] Market ì‚¬ìš© í›„ ì—°ì† êµ¬ë§¤ í…ŒìŠ¤íŠ¸ ---")
    
    # ìƒíƒœ ì´ˆê¸°í™”
    state.phase = Phase.ACTION
    player_a["actions"] = 1
    player_a["buys"] = 1
    player_a["gold"] = 10
    
    # Market ì¹´ë“œ ê°•ì œ ì§€ê¸‰ ë° ì‚¬ìš©
    player_a["hand"].append("Market")
    engine.play_card("User_A", "Market")
    
    print(f"Market ì‚¬ìš© ì§í›„ Buys: {player_a['buys']}")

    # í˜ì´ì¦ˆ ì „í™˜ (ACTION -> BUY)
    engine.next_phase()
    
    # ì—°ì† êµ¬ë§¤ ì‹œë„
    res1, _ = engine.buy_card("User_A", "Copper")
    res2, _ = engine.buy_card("User_A", "Copper")
    res3, msg3 = engine.buy_card("User_A", "Copper") # ì„¸ ë²ˆì§¸ëŠ” ì‹¤íŒ¨í•´ì•¼ í•¨
    
    print(f"êµ¬ë§¤ 1: {res1}, êµ¬ë§¤ 2: {res2}, êµ¬ë§¤ 3: {res3} (ì‹¤íŒ¨ ë©”ì‹œì§€: {msg3})")
    
    if res1 and res2 and not res3:
        print("\nâœ… ì‹œë‚˜ë¦¬ì˜¤ 2 ì„±ê³µ: Marketì˜ êµ¬ë§¤ ì¶”ê°€ íš¨ê³¼ê°€ ì •ìƒì ìœ¼ë¡œ ë°˜ì˜ë¨.")
    else:
        print("\nâŒ ì‹œë‚˜ë¦¬ì˜¤ 2 ì‹¤íŒ¨: êµ¬ë§¤ íšŸìˆ˜ ê³„ì‚°ì´ ë§ì§€ ì•ŠìŒ.")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ“œ [ìš”ì²­ì‚¬í•­ ë°˜ì˜] ì—”ì§„ ë‚´ë¶€ ì „ì²´ ë¡œê·¸ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n" + "="*50)
    print("ğŸ“œ [FULL LOG] ëª¨ë“  ê²Œì„ ì—”ì§„ ë¡œê·¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤")
    print("="*50)
    
    for i, log in enumerate(state.logs, 1):
        print(f"{i:02d} | {log}")
    
    print("="*50)

if __name__ == "__main__":
    test_buy_limit_logic()